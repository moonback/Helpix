import{h as c,s as l}from"./index-CZ_6CMrD.js";import{s as u}from"./utils-DGemFq7o.js";const m=c((i,o)=>({tasks:[],isLoading:!1,error:null,userLocation:null,selectedTask:null,taskFilters:{},taskSort:{field:"created_at",direction:"desc"},fetchTasks:async()=>{try{i({isLoading:!0,error:null});const{data:e,error:t}=await l.from("tasks").select("*").order("created_at",{ascending:!1});if(t)throw t;!e||e.length===0?i({tasks:[{id:1,user_id:"user-1",title:"Aide pour déménagement",description:"J'ai besoin d'aide pour déménager mes meubles ce weekend. J'habite au 3ème étage sans ascenseur.",category:"local",status:"in_progress",priority:"high",estimated_duration:4,actual_duration:2.5,location:"Paris 11ème, Rue de la Roquette",latitude:48.8566,longitude:2.3522,required_skills:["Déménagement","Force physique"],budget_credits:80,deadline:"2024-01-15T18:00:00",tags:["déménagement","urgent","weekend"],created_at:"2024-01-10T10:00:00",updated_at:"2024-01-10T10:00:00",progress_percentage:65,current_step:"Emballage des objets fragiles",total_steps:5,completed_steps:3,time_spent:150,last_activity:"2024-01-12T14:30:00",is_overdue:!1,complexity:"moderate",assigned_to:"user-2"},{id:2,user_id:"user-2",title:"Cours de cuisine italienne",description:"Je propose des cours de cuisine italienne à distance. Apprenez à faire des pâtes fraîches et des sauces authentiques !",category:"remote",status:"open",priority:"medium",estimated_duration:2,location:"En ligne",required_skills:["Cuisine","Italien"],budget_credits:60,tags:["cuisine","italien","cours"],created_at:"2024-01-09T14:30:00",updated_at:"2024-01-09T14:30:00",progress_percentage:0,total_steps:3,completed_steps:0,time_spent:0,last_activity:"2024-01-09T14:30:00",is_overdue:!1,complexity:"simple"},{id:3,user_id:"user-3",title:"Réparation vélo",description:"Mon vélo a un problème avec les freins. J'ai besoin d'aide pour le réparer ou de conseils.",category:"local",status:"completed",priority:"low",estimated_duration:1,actual_duration:1.5,location:"Lyon, Croix-Rousse",latitude:45.764,longitude:4.8357,required_skills:["Mécanique vélo"],budget_credits:30,tags:["vélo","réparation","mécanique"],created_at:"2024-01-08T16:45:00",updated_at:"2024-01-10T12:00:00",completion_date:"2024-01-10T12:00:00",rating:5,feedback:"Excellent travail, vélo parfaitement réparé !",progress_percentage:100,total_steps:3,completed_steps:3,time_spent:90,last_activity:"2024-01-10T12:00:00",is_overdue:!1,complexity:"simple",assigned_to:"user-4"},{id:4,user_id:"user-4",title:"Traduction anglais-français",description:"J'ai un document de 5 pages à traduire de l'anglais vers le français. Deadline dans 3 jours.",category:"remote",status:"on_hold",priority:"urgent",estimated_duration:3,location:"En ligne",required_skills:["Anglais","Français","Traduction"],budget_credits:100,deadline:"2024-01-13T23:59:00",tags:["traduction","anglais","français","urgent"],created_at:"2024-01-07T09:15:00",updated_at:"2024-01-11T10:00:00",progress_percentage:30,current_step:"Révision de la traduction",total_steps:4,completed_steps:1,time_spent:120,last_activity:"2024-01-11T10:00:00",is_overdue:!0,complexity:"complex",assigned_to:"user-5"},{id:5,user_id:"user-5",title:"Jardinage et entretien",description:"Je cherche quelqu'un pour m'aider à entretenir mon petit jardin. Arrosage, désherbage, taille des plantes.",category:"local",status:"review",priority:"medium",estimated_duration:2,actual_duration:2.2,location:"Marseille, Le Panier",latitude:43.2965,longitude:5.3698,required_skills:["Jardinage","Botanique"],budget_credits:45,tags:["jardinage","entretien","nature"],created_at:"2024-01-06T11:20:00",updated_at:"2024-01-12T16:00:00",progress_percentage:95,current_step:"Validation finale",total_steps:4,completed_steps:4,time_spent:132,last_activity:"2024-01-12T16:00:00",is_overdue:!1,complexity:"moderate",assigned_to:"user-1"}]}):i({tasks:e})}catch(e){console.error("Erreur lors de la récupération des tâches:",e),i({error:"Erreur lors de la récupération des tâches"})}finally{i({isLoading:!1})}},createTask:async e=>{try{i({isLoading:!0,error:null});const{data:t,error:a}=await l.from("tasks").insert([e]).select().single();if(a)throw a;i(r=>({tasks:[t,...r.tasks]}))}catch(t){throw console.error("Erreur lors de la création de la tâche:",t),i({error:"Erreur lors de la création de la tâche"}),t}finally{i({isLoading:!1})}},updateTask:async(e,t)=>{try{i({isLoading:!0,error:null});const{data:a,error:r}=await l.from("tasks").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(r)throw r;i(s=>({tasks:s.tasks.map(n=>n.id===e?{...n,...a}:n)}))}catch(a){throw console.error("Erreur lors de la mise à jour de la tâche:",a),i({error:"Erreur lors de la mise à jour de la tâche"}),a}finally{i({isLoading:!1})}},deleteTask:async e=>{try{i({isLoading:!0,error:null});const{error:t}=await l.from("tasks").delete().eq("id",e);if(t)throw t;i(a=>({tasks:a.tasks.filter(r=>r.id!==e)}))}catch(t){throw console.error("Erreur lors de la suppression de la tâche:",t),i({error:"Erreur lors de la suppression de la tâche"}),t}finally{i({isLoading:!1})}},updateTaskProgress:async(e,t,a)=>{var r;try{const s={progress_percentage:Math.max(0,Math.min(100,t)),updated_at:new Date().toISOString(),last_activity:new Date().toISOString()};a&&(s.current_step=a,s.completed_steps=Math.floor(t/100*(((r=o().tasks.find(n=>n.id===e))==null?void 0:r.total_steps)||1))),await o().updateTask(e,s)}catch(s){throw console.error("Erreur lors de la mise à jour du progrès:",s),s}},logTimeSpent:async(e,t)=>{try{const a=o().tasks.find(s=>s.id===e);if(!a)throw new Error("Tâche non trouvée");const r=(a.time_spent||0)+t;await o().updateTask(e,{time_spent:r,actual_duration:r/60,updated_at:new Date().toISOString(),last_activity:new Date().toISOString()})}catch(a){throw console.error("Erreur lors de l'enregistrement du temps:",a),a}},addTaskComment:async(e,t)=>{try{const a={...t,id:`comment_${Date.now()}`,created_at:new Date().toISOString()};console.log("Commentaire ajouté:",a);const r=o().tasks.find(s=>s.id===e);if(r){const s=[...r.comments||[],a];await o().updateTask(e,{comments:s,last_activity:new Date().toISOString()})}}catch(a){throw console.error("Erreur lors de l'ajout du commentaire:",a),a}},updateTaskStatus:async(e,t,a)=>{try{const r={status:t,updated_at:new Date().toISOString(),last_activity:new Date().toISOString()};t==="completed"&&(r.completion_date=new Date().toISOString(),r.progress_percentage=100),await o().updateTask(e,r),a&&await o().addTaskComment(e,{task_id:e,user_id:"system",content:`Statut changé vers "${t}": ${a}`,type:"progress_update",is_internal:!1})}catch(r){throw console.error("Erreur lors du changement de statut:",r),r}},assignTask:async(e,t)=>{try{await o().updateTask(e,{assigned_to:t,updated_at:new Date().toISOString(),last_activity:new Date().toISOString()}),await o().addTaskComment(e,{task_id:e,user_id:"system",content:`Tâche assignée à l'utilisateur ${t}`,type:"progress_update",is_internal:!1})}catch(a){throw console.error("Erreur lors de l'assignation:",a),a}},addTaskAttachment:async(e,t,a)=>{try{const r={id:`attachment_${Date.now()}`,task_id:e,file_name:t.name,file_url:URL.createObjectURL(t),file_type:t.type,file_size:t.size,uploaded_by:"current_user",uploaded_at:new Date().toISOString(),description:a},s=o().tasks.find(n=>n.id===e);if(s){const n=[...s.attachments||[],r];await o().updateTask(e,{attachments:n,last_activity:new Date().toISOString()})}}catch(r){throw console.error("Erreur lors de l'ajout de la pièce jointe:",r),r}},removeTaskAttachment:async(e,t)=>{var a;try{const r=o().tasks.find(s=>s.id===e);if(r){const s=((a=r.attachments)==null?void 0:a.filter(n=>n.id!==t))||[];await o().updateTask(e,{attachments:s,last_activity:new Date().toISOString()})}}catch(r){throw console.error("Erreur lors de la suppression de la pièce jointe:",r),r}},filterTasks:e=>{let t=o().tasks;return e.status&&e.status.length>0&&(t=t.filter(a=>e.status.includes(a.status))),e.priority&&e.priority.length>0&&(t=t.filter(a=>e.priority.includes(a.priority))),e.category&&e.category.length>0&&(t=t.filter(a=>e.category.includes(a.category))),e.assigned_to&&(t=t.filter(a=>a.assigned_to===e.assigned_to)),e.created_by&&(t=t.filter(a=>a.user_id===e.created_by)),e.complexity&&e.complexity.length>0&&(t=t.filter(a=>e.complexity.includes(a.complexity))),t},sortTasks:(e,t)=>{const a=[...e];return a.sort((r,s)=>{let n=r[t.field],d=s[t.field];return t.field==="progress"&&(n=r.progress_percentage||0,d=s.progress_percentage||0),typeof n=="string"&&(n=new Date(n).getTime(),d=new Date(d).getTime()),t.direction==="asc"?n>d?1:-1:n<d?1:-1}),a},searchTasks:e=>{const t=e.toLowerCase();return o().tasks.filter(a=>a.title.toLowerCase().includes(t)||a.description.toLowerCase().includes(t)||a.location.toLowerCase().includes(t)||a.required_skills.some(r=>r.toLowerCase().includes(t))||a.tags.some(r=>r.toLowerCase().includes(t)))},getDashboardData:()=>{const e=o().tasks,t=new Date,a=new Date(t.getTime()+3*24*60*60*1e3);return{total_tasks:e.length,completed_tasks:e.filter(s=>s.status==="completed").length,in_progress_tasks:e.filter(s=>s.status==="in_progress").length,overdue_tasks:e.filter(s=>s.is_overdue).length,upcoming_deadlines:e.filter(s=>s.deadline&&new Date(s.deadline)<=a&&s.status!=="completed"),recent_activity:[],performance_metrics:{completion_rate:e.length>0?e.filter(s=>s.status==="completed").length/e.length*100:0,average_completion_time:0,on_time_completion_rate:0,quality_average:0}}},getTasksByStatus:e=>o().tasks.filter(t=>t.status===e),getOverdueTasks:()=>o().tasks.filter(e=>e.is_overdue),getUpcomingDeadlines:e=>{const t=new Date,a=new Date(t.getTime()+e*24*60*60*1e3);return o().tasks.filter(r=>r.deadline&&new Date(r.deadline)<=a&&r.status!=="completed")},setUserLocation:(e,t)=>{i({userLocation:{latitude:e,longitude:t}})},getTasksByProximity:()=>{const{tasks:e,userLocation:t}=o();return!t||!t.latitude||!t.longitude?e:u(e,t.latitude,t.longitude)},setLoading:e=>i({isLoading:e}),setError:e=>i({error:e}),setSelectedTask:e=>i({selectedTask:e}),setTaskFilters:e=>i({taskFilters:e}),setTaskSort:e=>i({taskSort:e})}));export{m as u};
